worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  # Allow larger uploads during development
  client_max_body_size 50m;

  # Support WebSocket upgrades
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # Basic proxy settings
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # When proxying to another server, preserve headers and timeouts
  proxy_http_version 1.1;
  proxy_read_timeout 3600s;

  # Prefer the Docker API container, fall back to host-run API if available
  upstream plane_api {
    server api:8000 max_fails=3 fail_timeout=15s;
    server host.docker.internal:8000 max_fails=3 fail_timeout=15s backup;
  }

  proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
  proxy_connect_timeout 5s;

  server {
    listen 80;
    server_name localhost;

    # API (Django/ASGI)
    location ^~ /api/ {
      proxy_pass http://plane_api;
    }

    # Auth endpoints handled by API
    location ^~ /auth/ {
      proxy_pass http://plane_api;
    }

    # WebSockets to API (Channels)
    location ^~ /ws/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://plane_api;
    }

    # Admin app (Next.js dev on 3001) mounted at /god-mode
    location ^~ /god-mode/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://host.docker.internal:3001;
    }

    # Space app (Next.js dev on 3002) mounted at /spaces
    location ^~ /spaces/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://host.docker.internal:3002;
    }

    # Live collaboration server (Express dev on 3100) mounted at /live
    location = /live {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://host.docker.internal:3100;
    }

    location ^~ /live/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://host.docker.internal:3100;
    }

    # MinIO bucket path (default bucket: uploads)
    # Match both "/uploads" and "/uploads/" prefixes so presigned POSTs to bucket root work
    location ^~ /uploads {
      proxy_pass http://plane-minio:9000;
    }

    # Default: Web app (Next.js dev on 3000)
    location / {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://host.docker.internal:3000;
    }
  }
}
